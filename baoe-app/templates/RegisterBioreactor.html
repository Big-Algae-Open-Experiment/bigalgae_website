{% extends "Base.html" %}
{% block title %}Register - Big Algae Open Experiment{% endblock %}
{% block head %}
    {{ super() }}
    <style type="text/css">
        #map {
            height: 400px;
        }
    </style>
    <script>
        // This example adds a search box to a map, using the Google Place Autocomplete
        // feature. People can enter geographical searches. The search box will return a
        // pick list containing a mix of places and predicted search terms.

        function initAutocomplete() {
        map = new google.maps.Map(document.getElementById('map'), {    //// GLOBAL
            center: {lat: 54.468057, lng: -3.038273},
            zoom: 5,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            disableDefaultUI: true
        });

        // Create the search box and link it to the UI element.
        var input = document.getElementById('map_input');
        searchBox = new google.maps.places.SearchBox(input);  //// GLOBAL

        // Bias the SearchBox results towards current map's viewport.
        map.addListener('bounds_changed', function() {
            searchBox.setBounds(map.getBounds());
        });

        markers = [];    //// GLOBAL
        // [START region_getplaces]
        // Listen for the event fired when the user selects a prediction and retrieve
        // more details for that place.
        searchBox.addListener('places_changed', function() {
            var places = searchBox.getPlaces();

            if (places.length == 0) {
                return;
            }

            // Clear out the old markers.
            markers.forEach(function(marker) {
                marker.setMap(null);
            });
            markers = [];

            // For each place, get the icon, name and location.
            var bounds = new google.maps.LatLngBounds();
            places.forEach(function(place) {
                var icon = {
                    url: place.icon,
                    size: new google.maps.Size(71, 71),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(17, 34),
                    scaledSize: new google.maps.Size(25, 25)
                };

                // Create a marker for each place.
                markers.push(new google.maps.Marker({
                    map: map,
                    icon: icon,
                    title: place.name,
                    position: place.geometry.location
                }));

                if (place.geometry.viewport) {
                    // Only geocodes have viewport.
                    bounds.union(place.geometry.viewport);
                } else {
                    bounds.extend(place.geometry.location);
                }
            });
            map.fitBounds(bounds);
            map.setZoom(14);
            
            if (places.length == 1)
            {
                $("#optional_dropdown").empty();
                $("#optional_dropdown").parent().addClass('hidden');
                $("#optional_dropdown").removeAttr('required');
            }
            
            
            if (places.length > 1)
            {
                $("#optional_dropdown").empty();
                $("#optional_dropdown").parent().removeClass('hidden');
                $("#optional_dropdown").attr('required', true);
                $("#optional_dropdown").append('<option value="" selected disabled>Please select</option>');
                places.forEach(function(place) {
                    $("#optional_dropdown").append('<option>' + place.name + '</option>');
                });
            }
        });
        // [END region_getplaces]
        }
    </script>
    <script type="text/javascript">
    
        $(document).ready(function(){

            $('#optional_dropdown').change(function() {
                var places = searchBox.getPlaces();

                if (places.length == 0) {
                    return;
                }

                // Clear out the old markers.
                markers.forEach(function(marker) {
                    marker.setMap(null);
                });
                markers = [];

                // For each place, get the icon, name and location.
                var bounds = new google.maps.LatLngBounds();
                places.forEach(function(place) {
                    if (place.name == $('#optional_dropdown').val())
                    {
                        var icon = {
                            url: place.icon,
                            size: new google.maps.Size(71, 71),
                            origin: new google.maps.Point(0, 0),
                            anchor: new google.maps.Point(17, 34),
                            scaledSize: new google.maps.Size(25, 25)
                        };

                        // Create a marker for each place.
                        markers.push(new google.maps.Marker({
                            map: map,
                            icon: icon,
                            title: place.name,
                            position: place.geometry.location
                        }));

                        if (place.geometry.viewport) {
                            // Only geocodes have viewport.
                            bounds.union(place.geometry.viewport);
                        } else {
                            bounds.extend(place.geometry.location);
                        }
                    }
                });
                map.fitBounds(bounds);
                map.setZoom(14);
            });
            
        })
    </script>
    <script>
    
    function submitForm()
    {
        var places = searchBox.getPlaces();
        var selectedPlace;
        if (places.length == 1)
        {
            selectedPlace = places[0];
        } else if (places.length > 1)
        {
            places.forEach(function(place) {
                if (place.name == $('#optional_dropdown').val())
                {
                    selectedPlace = place;
                }
            });
        }
    
        var email = $('#email').val();
    
        $.ajax({
        url: "{{ url_for('register') }}", 
        type: "POST",
        data: JSON.stringify({"name" : selectedPlace.name,
                              "email" : email,
                              "longitude" : selectedPlace.geometry.location.lng(),
                              "latitude" : selectedPlace.geometry.location.lat()}),
        dataType:"json",
        contentType: 'application/json'}).always(
            function(data)
            {
                if ([200,0].indexOf(data.status) != -1)
                {
                    window.location = data.responseText;
                }
            });    
    }
    
    </script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA2PJtUfLZryy0ITEfJBzeRFAJWwDSPntk&libraries=places&callback=initAutocomplete">
    </script>
{% endblock %}
{% block body %}
    {{ super() }}
    
    <div class="container">
        <div class="row">
            <div class="col-md-9">
                <h2>Register</h2>
            </div> 
        </div>
        <div class="row">
            <div class="col-md-6">
                <div id="map"></div>
            </div>
            <div class="col-md-6">            
                <form id="form" target="_self" onsubmit="" action="javascript: submitForm()">
                    <div class="form-group">
                        <label class="control-label" for="map_input">Search for your school or institute</label>
                        <input type="name" class="form-control" name="map_input" id="map_input" required />
                    </div>
                    <div class="form-group hidden">
                        <label for="optional_dropdown">Your search returned multiple results. Please choose which one:</label>
                        <select class="form-control" name="optional_dropdown" id="optional_dropdown">
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="control-label" for="email">Email</label>
                        <input type="email" class="form-control" name="email" id="email" required />
                    </div>
                
                    <center><button type="submit" class="btn btn-success">SUBMIT</button></center>
                </form>                         
            </div> 
        </div>
    </div>

{% endblock %}
