{% extends "Base.html" %}
{% block title %}Register - Big Algae Open Experiment{% endblock %}
{% block head %}
    {{ super() }}
    <style type="text/css">
        #map {
            height: 800px;
        }
    </style>
    <script>
        function addMarkersToMap(reactor_array) {
            infowindows = [];
        
            var bounds = new google.maps.LatLngBounds();
            reactor_array.forEach(function(reactor) {
                var contentString = '<div id="content">'+
                    '<div id="siteNotice"></div>'+
                    '<a href="' + reactor.reactor_url + '"> <h3>Bioreactor ' + reactor._id + ' </h3></a>'+
                    '<h4>Team Name: ' + reactor.name + '</h4>' +
                    '<h4>Location: ' + reactor.location + '</h4>' +
                    '<h4>Number of experiments: ' + reactor.experiment_number + '</h4>' +
                    '</div>'

                var reactor_position = {lat: reactor.latitude, lng: reactor.longitude};

                var infowindow = new google.maps.InfoWindow({
                    content: contentString,
                    maxWidth: 250
                });

                var marker = new google.maps.Marker({
                    map: map,
                    position: reactor_position,
                    title: 'Bioreactor ' + reactor._id
                });
                
                marker.addListener('click', function() {
                    for (i = 0; i < infowindows.length; i++) { 
                        infowindows[i].close();
                    }                    
                    infowindow.open(map, marker);
                });

                infowindows.push(infowindow);
                
                bounds.extend(new google.maps.LatLng(reactor.latitude, reactor.longitude));
            });
            map.fitBounds(bounds);
        }
        
        function initReactorMap() {
            map = new google.maps.Map(document.getElementById('map'), {    //// GLOBAL
                center: {lat: 54.468057, lng: -3.038273},
                zoom: 5,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                disableDefaultUI: true,
                zoomControl: true
            });

            $.ajax({url: "{{ url_for('getallbioreactors') }}"}).done(
                function (data) {
                    var reactors = data.reactors;
                    addMarkersToMap(reactors);
                });
        };
    </script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA2PJtUfLZryy0ITEfJBzeRFAJWwDSPntk&callback=initReactorMap">
    </script>
{% endblock %}
{% block body %}
    {{ super() }}
    
    <div class="container">
        <div class="row">
            <div class="col-md-9">
                <h2>Reactor Map</h2>
                <p>Click on the markers to see further information about each bioreactor</p>
            </div> 
        </div>
        <div class="row">
            <div class="col-md-9">
                <div id="map"></div>
            </div>
        </div>
    </div>

{% endblock %}
